AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  SAM Template for the event based CD lambda
# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Handler: update-deployment
    Runtime: go1.x
    CodeUri: update-deployment/
    MemorySize: 128
    Timeout: 20
    Environment: 
      Variables:
      # All possible variables are set here for reference
        APPS_NAMESPACE: kl-apps
        BRANCH_NAME: main
        DEPLOYMENT_NAME: kidsloop-user-service
        EKS_ASSUME_ROLE: arn:aws:iam::828974637366:role/UpdateDeploymentEKSAssumeRole
        EKS_CLUSTER_NAME: kidskube-uk-kidskube-loadtest-eks
        EMIT_EVENT: 'false'
        EVENTBUS_NAME: loadtest-poc-event-bus
        EVENT_OUTPUT_SOURCE: live.kidsloop.kidskube-loadtest.user-updated
        LATEST_TAG: main
    ReservedConcurrentExecutions: 1
    EventInvokeConfig:
      DestinationConfig:
        OnFailure:
          Destination: arn:aws:events:eu-west-2:828974637366:event-bus/loadtest-poc-event-bus
          Type: EventBridge
        OnSuccess:
          Destination: arn:aws:events:eu-west-2:828974637366:event-bus/loadtest-poc-event-bus
          Type: EventBridge
    Architectures:
      - x86_64

Resources:
  userService:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      Description: Function to update the user service deployment based on ECR image scans
      Environment: # More info about Env Vars: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#environment-object
        Variables:
          DEPLOYMENT_NAME: kidsloop-user-service
          BRANCH_NAME: main
      Events:
        UpdateDeployment:
          Type: EventBridgeRule # More info about EventBridge Event Source: https://github.com/aws/serverless-application-model/blob/master/versions/2016-10-31.md#eventbridgerule
          Properties:
            EventBusName: loadtest-poc-event-bus
            Pattern:
              source:
                - aws.ecr
              detail-type:
                - ECR Image Scan
              detail:
                repository-name:
                - kidsloop-user
      FunctionName: loadtest-userService-update-deployment
      Policies:
      # Incorrectly flagged by vscode toolkit as incorrect type https://github.com/aws/aws-toolkit-vscode/issues/1974
        - Statement:
          - Effect: "Allow"
            Action: eks:DescribeCluster
            Resource: arn:aws:eks:eu-west-2:828974637366:cluster/kidskube-uk-kidskube-loadtest-eks
        - Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Resource: arn:aws:iam::828974637366:role/UpdateDeploymentEKSAssumeRole

  liveBackend:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      Description: Function to update the live backend deployment based on ECR image scans
      Environment: # More info about Env Vars: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#environment-object
        Variables:
          BRANCH_NAME: master
          DEPLOYMENT_NAME: kidsloop-live-backend
          LATEST_TAG: master-latest
      Events:
        UpdateDeployment:
          Type: EventBridgeRule # More info about EventBridge Event Source: https://github.com/aws/serverless-application-model/blob/master/versions/2016-10-31.md#eventbridgerule
          Properties:
            EventBusName: loadtest-poc-event-bus
            Pattern:
              source:
                - aws.ecr
              detail-type:
                - ECR Image Scan
              detail:
                repository-name:
                - kidsloop-live-backend
      FunctionName: loadtest-liveBackend-update-deployment
      Policies:
      # Incorrectly flagged by vscode toolkit as incorrect type https://github.com/aws/aws-toolkit-vscode/issues/1974
        - Statement:
          - Effect: "Allow"
            Action: eks:DescribeCluster
            Resource: arn:aws:eks:eu-west-2:828974637366:cluster/kidskube-uk-kidskube-loadtest-eks
        - Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Resource: arn:aws:iam::828974637366:role/UpdateDeploymentEKSAssumeRole

  cmsBackend:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      Description: Function to update the cms backend deployment based on ECR image scans
      Environment: # More info about Env Vars: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#environment-object
        Variables:
          DEPLOYMENT_NAME: kidsloop-cms-backend
      Events:
        UpdateDeployment:
          Type: EventBridgeRule # More info about EventBridge Event Source: https://github.com/aws/serverless-application-model/blob/master/versions/2016-10-31.md#eventbridgerule
          Properties:
            EventBusName: loadtest-poc-event-bus
            Pattern:
              source:
                - aws.ecr
              detail-type:
                - ECR Image Scan
              detail:
                repository-name:
                - kidsloop-cms-backend
      FunctionName: loadtest-cmsBackend-update-deployment
      Policies:
      # Incorrectly flagged by vscode toolkit as incorrect type https://github.com/aws/aws-toolkit-vscode/issues/1974
        - Statement:
          - Effect: "Allow"
            Action: eks:DescribeCluster
            Resource: arn:aws:eks:eu-west-2:828974637366:cluster/kidskube-uk-kidskube-loadtest-eks
        - Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Resource: arn:aws:iam::828974637366:role/UpdateDeploymentEKSAssumeRole

Outputs:
  # ServerlessRestApi is an implicit API created out of Events key under Serverless::Function
  # Find out more about other implicit resources you can reference within SAM
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  userServiceFunction:
    Description: "Update Deployment User Service Lambda Function ARN"
    Value: !GetAtt userService.Arn
  userServiceIAMRole:
    Description: "Implicit IAM Role created for User Service Update Deployment function"
    Value: !GetAtt userServiceRole.Arn
  liveBackendFunction:
    Description: "Update Deployment Live Backend Lambda Function ARN"
    Value: !GetAtt liveBackend.Arn
  liveBackendIAMRole:
    Description: "Implicit IAM Role created for Live Backend Update Deployment function"
    Value: !GetAtt liveBackendRole.Arn
  cmsBackendFunction:
    Description: "Update Deployment Live Backend Lambda Function ARN"
    Value: !GetAtt cmsBackend.Arn
  cmsBackendIAMRole:
    Description: "Implicit IAM Role created for Live Backend Update Deployment function"
    Value: !GetAtt cmsBackendRole.Arn